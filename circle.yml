general:
  branches:
    only:
     - master
     - develop

machine:
  environment:
    now: $(date +%Y%m%dT%H%M)
  node:
    version: 6.9.1    
  pre:

  # install newer docker
  - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0

  # install newer docker-compose
  - sudo pip install docker-compose

  # install jq
  - sudo apt-get install jq

  services:
    - docker

dependencies:
  override:

    # login to private registry
    - docker login -e="." -u="${DOCKER_USER}" -p="${DOCKER_PASS}" quay.io

    # build dynamic image tag/version number
    - echo "VERSION=$(jq -r .version < ./package.json)" > .env

test:
  override:

  # build image using version number generated by script above
  - docker-compose build

  # spin up stack and test
  - docker-compose up -d && sleep 10
  - docker-compose logs
  - npm test

deployment:
  CD:
    branch: master
    commands:

    # push to docker registry
    - docker-compose push    

    # deploy to harbor
    - docker-compose -f harbor-deploy.yml run deploy
