general:
  branches:
    only:
     - master
     - develop

machine:
  environment:
    now: $(date +%Y%m%dT%H%M)
  node:
    version: 6.9.1    
  pre:

  # install newer docker
  - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0

  # install newer docker-compose
  - pip install docker-compose

  # install jq
  - sudo apt-get install jq

  # install harbor-compose
  # - sudo wget -O /usr/local/bin/harbor-compose https://github.com/turnerlabs/harbor-compose/releases/download/0.9.1/ncd_linux_amd64 && sudo chmod +x /usr/local/bin/harbor-compose

  services:
    - docker

dependencies:
  override:

    # login to private registry
    - docker login -e="." -u="${DOCKER_USER}" -p="${DOCKER_PASS}" quay.io

    # build dynamic image tag/version number
    - echo "VERSION=$(jq -r .version < ./package.json).${CIRCLE_BUILD_NUM}" > .env

test:
  override:

  # build image using version number generated by script above
  - docker-compose build

  # spin up stack and test
  - docker-compose up -d
  - sleep 10
  - npm test

deployment:
  CD:
    branch: master
    commands:

    # push to docker registry
    - docker-compose push    

    # deploy to harbor
    #- source .env; harbor-compose deploy
    - docker run -it --env-file .env -v `pwd`:/work quay.io/turner/harbor-compose:0.10-pre-deploy5 deploy
